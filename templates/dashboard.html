{% extends "base.html" %}

{% block content %}
  <!DOCTYPE html>
  <meta http-equiv="refresh" content="300; URL=/dashboard">
  <html>
    <head>
      <script type="text/javascript" src="/smoothie.js"></script>
      <script type="text/javascript">
        function createTimeline() {
          macTimeLines = {};
          MAX_AGE = 5 * 60;
          chart = new SmoothieChart({millisPerPixel:300, minValue:-100, maxValue:0});
          setInterval(function() {
            $.getJSON( "/status", function( data ) {
              for(var i=0; i < data.length; i++) {
                if (macTimeLines.hasOwnProperty(data[i]['mac'])) {
                  if (Math.floor(Date.now() / 1000) + 60*60 - data[i]['measurements'][0]['last_seen'] < MAX_AGE) {
                    macTimeLines[data[i]['mac']].append(new Date().getTime(), data[i]['measurements'][0]['power']);
                  } else {
                    macTimeLines[data[i]['mac']].append(new Date().getTime(), -100);
                  }
                } else {
                  console.log("add " + data[i]['mac']);
                  macTimeLines[data[i]['mac']] = new TimeSeries();
                  if (Math.floor(Date.now() / 1000) + 60*60 - data[i]['measurements'][0]['last_seen'] < MAX_AGE) {
                    macTimeLines[data[i]['mac']].append(new Date().getTime(), data[i]['measurements'][0]['power']);
                  } else {
                    macTimeLines[data[i]['mac']].append(new Date().getTime(), -100);
                  }
                  chart.addTimeSeries(macTimeLines[data[i]['mac']], { strokeStyle: '#'+(Math.random()*0xFFFFFF<<0).toString(16), lineWidth: 4 });
                }
              }
            });
          }, 1000);
          chart.streamTo(document.getElementById("chart"), 500);
        }
      </script>
    </head>
    <body onload="createTimeline()">
    <center>
      <canvas id="chart" width="1000" height="500"></canvas>
    </center>
    <table class="table">
      <thead>
        <th>
          Location
        </th>
        <th>
          Employee
        </th>
        <th>
          Last seen
        </th>
        <th>
          MAC
        </th>
      </thead>
      <tbody>
        {% for location in current_locations %}
          <tr>
            <td>
              {{ location}}
            </td>
            <td>
              <ul>
                {% for device in current_locations[location] %}
                  <img class="profile-image img-circle" style="width: 25px; height: 25px" src="{{ device['avatar'] }}"></li>
                  {{ device['user'] }}</br>
                {% endfor %}
              </ul>
            </td>
            <td>
              {% for device in current_locations[location] %}
                {{ device['most_recent_seen'] }}</br>
              {% endfor %}
            </td>
            <td>
              {% for device in current_locations[location] %}
                {{ device['mac'] }}</br>
              {% endfor %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    </body>
  </html>
{% endblock %}
